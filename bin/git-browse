#!/usr/bin/env -S ruby --disable-all

def self.`(argv) = super.chomp.tap { exit(false) unless Process.last_status.success? }

branch = ARGV[0] || %x(git branch --show-current)

upstream = %x(git rev-parse --abbrev-ref=strict --symbolic-full-name "#{branch}@{push}")
remote, upstream = upstream.split("/", 2)

remote_url = %x(git remote get-url "#{remote}")
url = "#{remote_url.delete_suffix(".git")}"

if branch != "main"
  if ARGV.first == "--new"
    url += "/pull/new/#{upstream}"
  else
    url += "/pull/#{upstream}"
  end
end
exec "open", url
