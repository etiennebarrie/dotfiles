#!/bin/sh
set -e

red=; yellow=; green=; clear=
[ -t 2 ] && red="\033[0;31m"; green="\033[0;32m"; yellow="\033[0;33m"; clear="\033[m"

hook=$(git config --get core.hooksPath || echo "$(git rev-parse --git-dir)/hooks")/prepare-commit-msg
check_hook_writable() {
	if ! grep --silent --fixed-strings --line-regexp ": git-pair" "$hook"; then
		>&2 echo "${red}Keeping hook not generated by $0.$clear"
		exit 1
	fi
}

if [ $# = 0 ]; then
	if [ ! -w "$hook" ]; then
		exit
	fi
	check_hook_writable
	exec rm -f "$hook"
fi

author=$(git log --author="$1" -1 --format='%aN <%aE>')

if [ -z "$author" ]; then
	>&2 echo "${red}No author found for $yellow$1$red.$clear"
	exit 1
fi

if [ ! -f "$hook" ]; then
	cat <<-"HOOK" >"$hook"
		#!/bin/sh
		: git-pair
		set -e
		case "$2" in message|template|'') : ;; *) exit 0 ;; esac
	HOOK
	chmod u+x "$hook"
else
	check_hook_writable
fi

>&2 echo "Pairing with $green$author$clear."
grep --silent --fixed-strings "$author" "$hook" && exit 0

exec >>"$hook" echo "git interpret-trailers --trailer 'Co-authored-by: $author' --in-place \"\$1\""
